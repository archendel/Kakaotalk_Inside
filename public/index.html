<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>오픈 보드</title>
  <meta name="description" content="아무나 글을 올리고 함께 볼 수 있는 공유 게시판" />
  <style>
    :root { --bg:#0b0c10; --panel:#111318; --card:#151821; --muted:#9aa4b2; --text:#e6eaf0; --accent:#4f46e5; --accent-2:#22c55e; --ring:rgba(79,70,229,.4); --shadow:0 10px 30px rgba(0,0,0,.3); --radius:16px; }
    *{box-sizing:border-box} html,body{height:100%}
    body{margin:0;font-family:ui-sans-serif,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Apple SD Gothic Neo","Noto Sans KR","Malgun Gothic",sans-serif;background:linear-gradient(180deg,#0b0c10 0%,#0d0f15 100%);color:var(--text);-webkit-tap-highlight-color:transparent}
    header{position:sticky;top:0;z-index:30;backdrop-filter:saturate(180%) blur(10px);background:color-mix(in oklab,var(--panel) 80%,transparent);border-bottom:1px solid rgba(255,255,255,.06)}
    .wrap{max-width:900px;margin:0 auto;padding:16px}
    .brand{display:flex;align-items:center;gap:10px;padding:12px 4px}
    .logo{width:32px;height:32px;display:grid;place-items:center;border-radius:10px;background:linear-gradient(135deg,var(--accent),#7c3aed);box-shadow:var(--shadow)}
    h1{margin:0;font-size:20px;letter-spacing:-.3px}.sub{color:var(--muted);font-size:12px}

    .board{display:grid;gap:12px;padding:16px 4px 96px}
    @media(min-width:680px){.board{grid-template-columns:repeat(2,minmax(0,1fr))}}
    .empty{text-align:center;color:var(--muted);padding:48px 16px;border:1px dashed rgba(255,255,255,.12);border-radius:var(--radius);background:color-mix(in oklab,var(--card) 85%,transparent)}
    .card{background:color-mix(in oklab,var(--card) 92%,transparent);border:1px solid rgba(255,255,255,.06);border-radius:var(--radius);padding:14px 14px 12px;box-shadow:var(--shadow);display:flex;flex-direction:column;gap:10px}
    .meta{display:flex;align-items:center;justify-content:space-between;gap:12px;color:var(--muted);font-size:12px}
    .title{font-size:16px;font-weight:700;letter-spacing:-.2px}.content{white-space:pre-wrap;line-height:1.55;font-size:14px}

    .fab{position:fixed;right:18px;bottom:24px;z-index:50;width:60px;height:60px;border-radius:999rem;background:linear-gradient(135deg,var(--accent),#7c3aed);color:#fff;border:none;display:grid;place-items:center;box-shadow:0 12px 30px rgba(79,70,229,.45);cursor:pointer}
    .fab:active{transform:translateY(1px)}

    .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.4);backdrop-filter:blur(2px);opacity:0;pointer-events:none;transition:opacity .2s ease;z-index:60}
    .sheet{position:fixed;left:0;right:0;bottom:0;z-index:70;transform:translateY(110%);transition:transform .25s ease}
    .sheet-inner{max-width:900px;margin:0 auto;padding:16px;background:var(--panel);border-radius:20px 20px 0 0;border-top:1px solid rgba(255,255,255,.08);box-shadow:0 -10px 30px rgba(0,0,0,.35)}
    .sheet header{position:static;border:none;backdrop-filter:none;background:transparent}
    .sheet.open{transform:translateY(0%)} .backdrop.show{opacity:1;pointer-events:auto}

    form{display:grid;gap:12px}.row{display:grid;gap:10px}@media(min-width:560px){.row{grid-template-columns:1.2fr .8fr}}
    label{font-size:13px;color:var(--muted)} input[type=text],textarea{width:100%;padding:12px;border-radius:12px;border:1px solid rgba(255,255,255,.12);background:color-mix(in oklab,var(--card) 92%,transparent);color:var(--text);outline:none;font-size:14px}
    input:focus,textarea:focus{border-color:var(--ring);box-shadow:0 0 0 4px var(--ring)} textarea{min-height:120px;resize:none;line-height:1.55}

    .actions{display:flex;justify-content:space-between;align-items:center;gap:10px;padding-top:6px}
    .btn{padding:10px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.14);background:transparent;color:var(--text);cursor:pointer}
    .btn.primary{background:linear-gradient(135deg,var(--accent-2),#16a34a);border-color:transparent;color:#fff;box-shadow:var(--shadow)}

    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
    .toast{position:fixed;left:50%;bottom:100px;transform:translateX(-50%) translateY(20px);background:#1d232f;color:var(--text);padding:10px 14px;border-radius:12px;border:1px solid rgba(255,255,255,.12);box-shadow:var(--shadow);opacity:0;transition:all .25s ease;z-index:80}
    .toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
    .loadmore-wrap{display:flex;justify-content:center;padding:10px}
  </style>
</head>
<body>
  <header>
    <div class="wrap brand" aria-label="사이트 헤더">
      <div class="logo" aria-hidden="true">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M3 21l3.75-.75L19.92 7.08a1.5 1.5 0 10-2.12-2.12L4.62 18.13 3 21z" fill="white"/></svg>
      </div>
      <div>
        <h1>오픈 보드</h1>
        <div class="sub">아무나 글을 자유롭게 올리는 곳</div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section id="board" class="board" aria-live="polite" aria-busy="false"></section>
    <div id="emptyState" class="empty" role="status">아직 글이 없어요. 오른쪽 아래 연필 버튼을 눌러 첫 글을 올려보세요.</div>
    <div class="loadmore-wrap"><button id="loadMore" class="btn" style="display:none">더 보기</button></div>
  </main>

  <button id="fab" class="fab" aria-label="글쓰기 열기">
    <svg width="26" height="26" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg" aria-hidden="true"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04a1.003 1.003 0 000-1.42l-2.34-2.34a1.003 1.003 0 00-1.42 0l-1.83 1.83 3.75 3.75 1.84-1.82z" fill="white"/></svg>
  </button>

  <div id="backdrop" class="backdrop" aria-hidden="true"></div>
  <aside id="sheet" class="sheet" role="dialog" aria-modal="true" aria-labelledby="sheetTitle" aria-hidden="true">
    <div class="sheet-inner">
      <header class="wrap" style="padding:8px 0 10px">
        <h2 id="sheetTitle" style="margin:0; font-size:18px">새 글 쓰기</h2>
      </header>
      <form id="postForm" class="wrap" autocomplete="off">
        <div class="row">
          <div>
            <label for="title">제목</label>
            <input id="title" name="title" type="text" maxlength="80" placeholder="제목을 입력하세요" required />
          </div>
          <div>
            <label for="nick">닉네임</label>
            <input id="nick" name="nick" type="text" maxlength="24" placeholder="닉네임" required />
          </div>
        </div>
        <div>
          <label for="content">내용</label>
          <textarea id="content" name="content" placeholder="무엇이든 적어보세요" required></textarea>
        </div>
        <div class="actions">
          <button type="button" class="btn" id="cancelBtn" aria-label="닫기">취소</button>
          <button type="submit" class="btn primary" aria-label="올리기">올리기</button>
        </div>
        <p class="sub" style="margin: 0; text-align:right">모든 글은 서버(PostgreSQL)에 저장됩니다.</p>
      </form>
    </div>
  </aside>

  <div id="toast" class="toast" role="status" aria-live="polite">글이 등록되었습니다.</div>

  <script>
    const el = (s)=>document.querySelector(s);
    const board = el('#board');
    const empty = el('#emptyState');
    const fab = el('#fab');
    const sheet = el('#sheet');
    const backdrop = el('#backdrop');
    const form = el('#postForm');
    const titleInput = el('#title');
    const nickInput = el('#nick');
    const contentInput = el('#content');
    const cancelBtn = el('#cancelBtn');
    const toast = el('#toast');
    const loadMoreBtn = el('#loadMore');

    const escapeHTML = (str)=>str.replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[ch]));
    const pad = (n)=>String(n).padStart(2,'0');
    const fmt = (iso)=>{ const d=new Date(iso); return `${d.getFullYear()}.${pad(d.getMonth()+1)}.${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}` }

    let cursor = 0; // 마지막으로 로드한 맨 아래 id
    let loading = false;

    async function fetchPosts(initial=false){
      if(loading) return; loading = true; board.setAttribute('aria-busy','true');
      try{
        const url = new URL('/api/posts', location.origin);
        if(cursor>0) url.searchParams.set('cursor', String(cursor));
        url.searchParams.set('limit','20');
        const res = await fetch(url);
        if(!res.ok) throw new Error('failed');
        const { items, nextCursor } = await res.json();
        renderAppend(items);
        cursor = nextCursor || 0;
        loadMoreBtn.style.display = nextCursor ? 'inline-flex' : 'none';
        empty.style.display = (board.children.length===0) ? 'block' : 'none';
      }catch(e){ console.error(e); showToast('목록을 불러오지 못했습니다.'); }
      finally{ loading=false; board.setAttribute('aria-busy','false'); }
    }

    function renderAppend(items){
      const frag = document.createDocumentFragment();
      items.forEach(p=>{
        const card = document.createElement('article');
        card.className='card';
        card.innerHTML = `
          <div class="title">${escapeHTML(p.title)}</div>
          <div class="content">${escapeHTML(p.content)}</div>
          <div class="meta"><span>by ${escapeHTML(p.nick)}</span><time datetime="${p.created_at}">${fmt(p.created_at)}</time></div>
        `;
        frag.appendChild(card);
      });
      board.appendChild(frag);
    }

    function openSheet(){ sheet.classList.add('open'); sheet.setAttribute('aria-hidden','false'); backdrop.classList.add('show'); backdrop.setAttribute('aria-hidden','false'); setTimeout(()=>titleInput.focus(),50); }
    function closeSheet(){ sheet.classList.remove('open'); sheet.setAttribute('aria-hidden','true'); backdrop.classList.remove('show'); backdrop.setAttribute('aria-hidden','true'); form.reset(); autosize(); }

    fab.addEventListener('click', openSheet);
    backdrop.addEventListener('click', closeSheet);
    cancelBtn.addEventListener('click', closeSheet);

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const title = titleInput.value.trim();
      const nick = nickInput.value.trim();
      const content = contentInput.value.trim();
      if(!title || !nick || !content) return;
      try{
        const res = await fetch('/api/posts', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ title, nick, content }) });
        const data = await res.json();
        if(!res.ok) throw new Error(data.error || 'error');
        board.innerHTML = '';
        cursor = 0;
        await fetchPosts(true);
        closeSheet();
        showToast('글이 등록되었습니다.');
      }catch(err){ showToast(err.message || '올리기에 실패했습니다.'); }
    });

    function autosize(){ contentInput.style.height='auto'; contentInput.style.height=Math.min(300, contentInput.scrollHeight)+'px'; }
    contentInput.addEventListener('input', autosize);

    function showToast(msg){ toast.textContent = msg; toast.classList.add('show'); setTimeout(()=>toast.classList.remove('show'), 1600); }

    loadMoreBtn.addEventListener('click', ()=> fetchPosts());

    // 초기 로드
    fetchPosts(true);
  </script>
</body>
</html>
